<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OGS AI - Full Screen Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
  /* Your existing styles for markdown and dots (unchanged) */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .typing-dot {
    width: 8px; height: 8px; border-radius: 50%; background: #9ca3af;
    margin: 0 2px; animation: pulse 1.5s infinite ease-in-out;
  }
  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.3s; }
  .typing-dot:nth-child(3) { animation-delay: 0.6s; }
  /* Additional markdown styles omitted for brevity */
</style>
</head>
<body class="h-full bg-gray-900 text-gray-100 flex flex-col">

<div class="flex flex-col h-full">
<header class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700 sticky top-0 z-10">
  <div class="flex items-center space-x-3">
    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center">
      <img src="logo.png" alt="OGS AI Logo" class="w-6 h-6" />
    </div>
    <h1 class="font-bold text-lg">OGS AI</h1>
  </div>
  <div class="flex space-x-3">
    <button id="newChatBtn" class="text-gray-300 hover:text-white" title="Start New Chat"><i class="fas fa-plus"></i></button>
    <button id="settingsBtn" class="text-gray-300 hover:text-white" title="Settings"><i class="fas fa-cog"></i></button>
  </div>
</header>

<div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
  <div id="welcomeMsg" class="flex flex-col items-center justify-center h-full text-center text-gray-400 py-12">
    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center mb-4">
      <img src="logo.png" alt="OGS AI Logo" class="w-10 h-10" />
    </div>
    <h2 class="text-2xl font-bold mb-2">Welcome to OGS AI</h2>
    <p class="max-w-md">Ask me anything, or start with a prompt. Use "image:" to generate images.</p>
    <div class="mt-6 grid grid-cols-2 gap-3 w-full max-w-md" id="quickPrompts">
      <button data-prompt='Explain quantum computing in simple terms' class="bg-gray-800 hover:bg-gray-700 rounded-lg p-3 text-left text-sm">"Explain quantum computing in simple terms"</button>
      <button data-prompt='Write a poem about artificial intelligence' class="bg-gray-800 hover:bg-gray-700 rounded-lg p-3 text-left text-sm">"Write a poem about artificial intelligence"</button>
      <button data-prompt='How do I center a div in CSS?' class="bg-gray-800 hover:bg-gray-700 rounded-lg p-3 text-left text-sm">"How do I center a div in CSS?"</button>
      <button data-prompt='A futuristic city at sunset' class="bg-gray-800 hover:bg-gray-700 rounded-lg p-3 text-left text-sm">image: A futuristic city at sunset</button>
    </div>
  </div>
</div>

<div class="p-4 bg-gray-800 border-t border-gray-700 relative">
  <div class="relative">
    <textarea id="msg" placeholder="Ask anything..." class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-purple-600" rows="1" style="min-height:44px; max-height:200px"></textarea>
    <button id="sendBtn" class="absolute right-3 bottom-3 text-gray-400 hover:text-purple-400"><i class="fas fa-paper-plane"></i></button>
  </div>
  <p class="text-xs text-gray-500 text-center mt-2">OGS AI can make mistakes. Verify critical info.</p>
</div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const chat = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");

// Persist chat ID in localStorage
let chatId = localStorage.getItem('chat_id');

// Create a new chat if none exists
async function createChatIfNeeded() {
  if (!chatId) {
    try {
      const response = await fetch(`${API_BASE_URL}/chat/new`, { method: 'POST' });
      const data = await response.json();
      if (data.chat_id) {
        chatId = data.chat_id;
        localStorage.setItem('chat_id', chatId);
        // Optionally, update URL or display chat ID
        // For now, user just continues in same tab
      }
    } catch (err) {
      console.error('Error creating chat:', err);
    }
  }
}
// Ensure chat exists on page load
createChatIfNeeded();

function createMsgHtml(content, isUser) {
  return `
    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
      <div class="max-w-[90%] rounded-lg p-4 ${isUser ? 'bg-purple-600 text-white' : 'bg-gray-'}">
        <div class="message-content">${content}</div>
        <div class="text-xs mt-2 ${isUser ? 'text-purple-200' : 'text-gray-400'} text-right">
          ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
        </div>
      </div>
    </div>`;
}

function showTyping() {
  if (!document.getElementById("typing-indicator")) {
    chat.insertAdjacentHTML('beforeend', `
      <div id="typing-indicator" class="flex justify-start">
        <div class="ai-message rounded-lg p-4 flex space-x-2 items-center">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <span class="ml-2 text-gray-400 text-sm">OGS AI is typing...</span>
        </div>
      </div>
    `);
    chat.scrollTop = chat.scrollHeight;
  }
}

function hideTyping() {
  document.getElementById("typing-indicator")?.remove();
}

function addMessage(content, isUser) {
  if (document.getElementById("welcomeMsg")) document.getElementById("welcomeMsg").remove();
  if (document.getElementById("quickPrompts")) document.getElementById("quickPrompts").remove();
  const html = createMsgHtml(content, isUser);
  chat.insertAdjacentHTML("beforeend", html);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMsg() {
  const text = document.getElementById("msg").value.trim();
  if (!text) return;
  addMessage(text, true);
  await createChatIfNeeded(); // ensure chat exists
  // Send message with explicit chat_id and model
  socket.emit("send_message", { message: text, model: "reka-core", chat_id: chatId });
  document.getElementById("msg").value = "";
  document.getElementById("msg").style.height = "44px";
  showTyping();
}

// Event listeners
document.getElementById("sendBtn").addEventListener("click", () => {
  sendMsg();
});
document.getElementById("msg").addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMsg();
  }
});

// Quick prompts
document.querySelectorAll('button[data-prompt]').forEach(btn => {
  btn.addEventListener("click", () => {
    document.getElementById("msg").value = btn.dataset.prompt;
    document.getElementById("msg").focus();
    document.getElementById("msg").dispatchEvent(new Event("input"));
  });
});

// Start new chat on button, clear local storage
document.getElementById("newChatBtn").onclick = () => {
  if (confirm("Start a new chat?")) {
    localStorage.removeItem('chat_id');
    chat.innerHTML = `
      <div class="flex flex-col items-center justify-center h-full text-center text-gray-400 py-12" id="welcomeMsg">
        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center mb-4">
          <img src="logo.png" alt="OGS AI Logo" class="w-10 h-10" />
        </div>
        <h2 class="text-2xl font-bold mb-2">New Chat Started</h2>
        <p class="max-w-md">Ask me anything or choose a prompt.</p>
      </div>`;
    chatId = null;
    createChatIfNeeded();
  }
};
// Settings button
document.getElementById("settingsBtn").onclick = () => {
  alert("Settings coming soon!");
};

// Show typing indicator
function showTyping() {
  if (!document.getElementById("typing-indicator")) {
    chat.insertAdjacentHTML('beforeend', `
      <div id="typing-indicator" class="flex justify-start">
        <div class="ai-message rounded-lg p-4 flex space-x-2 items-center">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <span class="ml-2 text-gray-400 text-sm">OGS AI is typing...</span>
        </div>
      </div>
    `);
    chat.scrollTop = chat.scrollHeight;
  }
}

function hideTyping() {
  document.getElementById("typing-indicator")?.remove();
}

// Handle incoming messages
socket.on("message", (data) => {
  hideTyping();
  addMessage(data.message, false);
});
socket.on("error", (err) => {
  hideTyping();
  addMessage("<span class='text-red-400 font-medium'>Error:</span> " + err.message, false);
});
</script>
</body>
</html>
